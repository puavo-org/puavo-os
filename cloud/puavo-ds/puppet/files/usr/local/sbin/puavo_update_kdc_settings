#!/usr/bin/ruby

#databases = `ldapsearch -Q -Y EXTERNAL -H ldapi:/// -s base -b "" "(objectClass=*)" namingContexts 2>/dev/null | grep namingContexts:`
databases = `slapcat -b cn=config | grep olcSuffix 2>/dev/null`

puts databases.inspect

hostname = `hostname -f`.chomp

@organisations = []

databases.split("\n").each do |line|
  if /olcSuffix: (.*)/.match(line)
    suffix = $1
    organisation = {}

    if not /o=puavo/i.match(suffix) 
      organisation['suffix'] = suffix

      tmp_dbinfo = `slapcat -a "(objectClass=eduOrg)" -b #{suffix} 2>/dev/null`

      if /puavoDomain: (.*)/.match(tmp_dbinfo)
        organisation['domain'] = $1
      end

      if /puavoKerberosRealm: (.*)/.match(tmp_dbinfo)
        organisation['realm'] = $1
      end

      if /puavoKadminPort: (.*)/.match(tmp_dbinfo)
        organisation['kadmin_port'] = $1
      end

      puts "ORG: #{organisation['realm']} #{organisation['kadmin_port']}"

      @organisations.push organisation

      smbkrb5pwd_kt = `echo "read_kt /etc/ldap/slapd.d/openldap-krb5.keytab\nlist" | sudo ktutil 2>/dev/null|grep smbkrb5pwd/#{hostname}@#{organisation['realm']}`.chomp
      ldap_kt = `echo "read_kt /etc/ldap/slapd.d/openldap-krb5.keytab\nlist" | sudo ktutil 2>/dev/null|grep ldap/#{hostname}@#{organisation['realm']}`.chomp

      if smbkrb5pwd_kt.empty?
        smbkrb5pwd_princ = `kadmin.local -r #{organisation['realm']} -q "listprincs" | grep smbkrb5pwd/#{hostname}@#{organisation['realm']}`.chomp

        if smbkrb5pwd_princ.empty?
          puts "Creating smbkrb5pwd/#{hostname}@#{organisation['realm']} principal"
          `kadmin.local -r #{organisation['realm']} -q "addprinc -randkey smbkrb5pwd/#{hostname}@#{organisation['realm']}"`
        end

        puts "Exporting smbkrb5pwd/#{hostname}@#{organisation['realm']} to keytab"
        puts `kadmin.local -r #{organisation['realm']} -q "ktadd -e des-cbc-crc:normal -k /etc/ldap/slapd.d/openldap-krb5.keytab smbkrb5pwd/#{hostname}@#{organisation['realm']}"`
      end

      if ldap_kt.empty?
        ldap_princ = `kadmin.local -r #{organisation['realm']} -q "listprincs" | grep ldap/#{hostname}@#{organisation['realm']}`.chomp

        if ldap_princ.empty?
          puts "Creating ldap/#{hostname}@#{organisation['realm']} principal"
          `kadmin.local -r #{organisation['realm']} -q "addprinc -randkey ldap/#{hostname}@#{organisation['realm']}"`
        end

        puts "Exporting ldap/#{hostname}@#{organisation['realm']} to keytab"
        puts `kadmin.local -r #{organisation['realm']} -q "ktadd -e des-cbc-crc:normal -k /etc/ldap/slapd.d/openldap-krb5.keytab ldap/#{hostname}@#{organisation['realm']}"`
      end
    end
  end
end

`chown root.openldap /etc/ldap/slapd.d/openldap-krb5.keytab`
`chmod 0640 /etc/ldap/slapd.d/openldap-krb5.keytab`

`/etc/init.d/slapd restart`
`sleep 5`
`/etc/init.d/krb5-kdc restart`
`/etc/init.d/puavo_kadmind restart`
