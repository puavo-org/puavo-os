#!/bin/sh

set -eu

txpower=$(jq -r '.tags[]' /etc/puavo/device.json | sed -r -n 's/^txpower://p' | tail -n1)
txpower5=$(jq -r '.tags[]' /etc/puavo/device.json | sed -r -n 's/^txpower5://p' | tail -n1)

hosttype=$(cat /etc/puavo/hosttype)
if [ "${hosttype}" = laptop ]; then
    echo "ERROR: tried to set txpower on laptop, aborting" >&2
    exit 1
fi

if [ -n "${txpower}" ]; then
    iwconfig "${INTERFACE}" txpower "${txpower}"
fi

if [ -n "${txpower5}" ]; then
    ## txpower5 affects only devices with HW_MODE a (devices
    ## implementing 802.11a which defines 5GHz band)
    /usr/lib/puavo-wlanap/find-ifaces a | grep -q -x "${INTERFACE}" && {
        iwconfig "${INTERFACE}" txpower "${txpower5}"
    }
fi
