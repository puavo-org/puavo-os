(
  set -e

  is_enabled=$(puavo-conf -b puavo.autopilot.enabled)
  [ "${is_enabled}" = true ] || exit 0

  mode=$(puavo-conf puavo.autopilot.mode)
  username=$(puavo-conf puavo.autopilot.username)
  password=$(puavo-conf puavo.autopilot.password)

  if [ -n "$user" -a -n "$password" ]; then
    if [ "${mode}" = "smoke" ]; then
      puavo-autopilot-logger --tag smoke                        \
                             --                                 \
                             'msg=enter-display-manager-screen' \
                             "user=$user"                       \
          || true
    fi
    sleep 15

    ## The "Guest Session" widget might be the active one, click up
    ## arrow to activate the normal login widget.
    xte 'key Up'
    sleep 1

    ## The login widget might be dirty, click esc to clear it.
    xte 'key Escape'
    sleep 1

    xte "str ${user}"
    xte 'key Return'
    sleep 4 ## Password widget activates slowly.

    xte "str ${password}"
    xte 'key Return'

    if [ "${mode}" = "smoke" ]; then
      puavo-autopilot-logger --tag smoke                     \
                             --                              \
                             'msg=try-display-manager-login' \
                             "user=$user"                    \
          || true
    fi
  fi
) &
