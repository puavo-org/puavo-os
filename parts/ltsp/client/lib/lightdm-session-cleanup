#!/bin/sh

set -eu

# This script is run as root (from lightdm).

puavo_guestlogin_mode=$(puavo-conf puavo.guestlogin.mode)
if [ "${puavo_guestlogin_mode}" = automatic ]; then
    /bin/systemctl try-restart lightdm
    exit $?
fi

# This is for shutting down thin clients.  "puavo-ltsp-client-action" in the
# thin client case sets up an X property, kills the desktop session, and this
# script then picks up this and may trigger either a reboot or a shutdown.

logout_action=$(xprop -root -notype LTSP_LOGOUT_ACTION \
                  | sed -ne 's/^LTSP_LOGOUT_ACTION = "\(.*\)"/\1/p' || true)

# Check if the user requested a shutdown or a reboot.
case "$logout_action" in
  HALT)   /sbin/poweroff ;;
  REBOOT) /sbin/reboot   ;;
  *)                     ;;
esac
