#!/bin/bash

set -eu
set -o pipefail

g_exitval=1
g_no_efi_is_ok=false
g_cmd=
PID_FILE=/run/puavo-manage-efi.pid # Locks this file to ensure only one puavo-manage-efi is running

on_exit()
{
  set +e

  rm -f "${PID_FILE}"

  if [ ${g_exitval} -ne 0 ]; then
    logerr 'Failed!'
  fi

  exit ${g_exitval}
}

loginfo() {
  printf "INFO: %s\n" "$1" >&2
}

logwarning() {
  printf "WARNING: %s\n" "$1" >&2
}

logerr() {
  printf "ERROR: %s\n" "$1" >&2
}

efibootmgr_windows() {
  efibootmgr_flag=$1
  shift

  for boot_entry in $(efibootmgr | awk '/Windows/ {print substr($0,5,4)}'); do
    efibootmgr -q "${efibootmgr_flag}" -b "${boot_entry}" || return 1
  done

  return 0
}

mount_efi_system_partition() {
  efi_system_partition_devpath=$(lsblk -n -l -o PATH,PARTTYPE | awk '$2 == "c12a7328-f81f-11d2-ba4b-00a0c93ec93b" {print $1}') || return 1
  if [ -z "${efi_system_partition_devpath}" ]; then
    logerr 'EFI system partition not found'
    return 1
  fi

  efi_system_partition_mountpath=$(awk "-vdev=${efi_system_partition_devpath}" '$1 == dev {print $2}' /proc/mounts) || return 1

  # Mount only if not already mounted.
  if [ -z "${efi_system_partition_mountpath}" ]; then
    efi_system_partition_mountpath=/boot/efi
    mkdir -p "${efi_system_partition_mountpath}" || return 1
    mount -onodev,nosuid "${efi_system_partition_devpath}" "${efi_system_partition_mountpath}" || return 1
  fi

  echo "${efi_system_partition_mountpath}"
}

efi_break_windows() {
  efi_mount_path=$(mount_efi_system_partition) || return 1

  if [ -d "${efi_mount_path}/EFI/Microsoft" ]; then
    loginfo 'Defusing Windows...'
    if [ -e "${efi_mount_path}/EFI/Puavo-defused-Windows.tar.gz" ]; then
      logerr "Failed to defuse Windows, '${efi_mount_path}/EFI/Puavo-defused-Windows.tar.gz' already exists"
      return 1
    fi

    defused_windows_tmpfile=$(mktemp -p "${efi_mount_path}/EFI" 'Puavo-defused-Windows.tar.gz.tmp.XXXXXXXX')
    tar -C "${efi_mount_path}/EFI" -z -c -f "${defused_windows_tmpfile}" Microsoft || {
      rm -rf "${defused_windows_tmpfile}" || true
      umount "${efi_mount_path}"
      return 1
    }
    mv "${defused_windows_tmpfile}" "${efi_mount_path}/EFI/Puavo-defused-Windows.tar.gz"
    rm -rf "${efi_mount_path}/EFI/Microsoft" || {
      umount "${efi_mount_path}"
      return 1
    }
    loginfo 'Windows defused.'
  else
    loginfo 'Nothing to do.'
  fi

  umount "${efi_mount_path}"
}

efi_fix_windows() {
  efi_mount_path=$(mount_efi_system_partition) || return 1

  if [ -f "${efi_mount_path}/EFI/Puavo-defused-Windows.tar.gz" ]; then
    loginfo 'Repriming Windows...'
    if [ -e  "${efi_mount_path}/EFI/Microsoft" ]; then
      logerr "Failed to reprime Windows: '${efi_mount_path}/EFI/Microsoft' already exists"
      return 1
    fi
    tar -C "${efi_mount_path}/EFI" -z -x -f "${efi_mount_path}/EFI/Puavo-defused-Windows.tar.gz" || {
      rm -rf "${efi_mount_path}/EFI/Microsoft" || true
      umount "${efi_mount_path}"
      return 1
    }
    rm -f "${efi_mount_path}/EFI/Puavo-defused-Windows.tar.gz" || {
      umount "${efi_mount_path}"
      return 1
    }
    loginfo 'Windows reprimed.'
  else
    loginfo 'Nothing to do.'
  fi

  umount "${efi_mount_path}"
}

efi_disable_windows() {
  if [ "$(puavo-conf puavo.grub.windows.defuse_efi_boot_when_disabled)" != 'true' ]; then
    logwarning "puavo.grub.windows.defuse_efi_boot_when_disabled is not true, not disabling Windows EFI boot"
    return 0
  fi

  efibootmgr_windows -A || return 1
  efi_break_windows
}

efi_enable_windows() {
  efi_fix_windows || return 1
  efibootmgr_windows -a
}

has_efi() {
  grep -q '^efivarfs ' /proc/mounts
}

usage() {
  echo "Usage: $0 [OPTIONS] COMMAND"
  echo "       $0 --help"
}

usage_error() {
  local msg

  msg=$1
  shift
  
  echo "ERROR: ${msg}" >&2
  usage >&2

  exit 1
}

while [ $# -gt 0 ]; do
    case $1 in
        -h|--help)
          shift
          {
            usage
            echo
            echo "Manage EFI boot. Modifies EFI boot order and ESP."
            echo
            echo "Commands:"
            echo "    disable-windows              disable Windows"
            echo "    enable-windows               enable Windows"
            echo
            echo "Options:"
            echo "    --no-efi-is-ok               exit with status 0 if the system does not use EFI"
            echo "    -h, --help                   print help and exit"
            echo
          } >&2
          exit 0
          ;;
        --no-efi-is-ok)
          shift
          g_no_efi_is_ok=true
          ;;
        --)
          shift
          break
          ;;
        -*)
          usage_error "invalid argument '$1'"
          ;;
        *)
          break
          ;;
    esac
done

if [ $# -ne 1 ]; then
  usage_error "invalid number of arguments ($#), expected 1"
fi

g_cmd=$1
shift

if ! has_efi; then
  if ${g_no_efi_is_ok}; then
    logwarning "this system does not have EFI"
    exit 0
  else
    logerr "this system does not have EFI"
    exit 1
  fi
fi

exec {lockfd}<> "${PID_FILE}"
flock -x -n "${lockfd}" || {
    logerr "puavo-manage-efi is already running!"
    exit 1
}

trap on_exit EXIT

echo "$$" >"${PID_FILE}"

case "${g_cmd}" in
  enable-windows)
    efi_enable_windows
  ;;
  disable-windows)
    efi_disable_windows
  ;;
  *)
    usage_error "invalid command '${g_cmd}'"
esac

g_exitval=0
