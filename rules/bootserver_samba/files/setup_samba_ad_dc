#!/bin/sh

set -eu

if [ "$(puavo-conf puavo.service.samba-ad-dc.enabled)" != 'true' ]; then
  exit 0
fi

if [ ! -e /var/lib/samba-ad-dc/.puavo_provisioning_done ]; then
  exit 0
fi

read puavo_hostname             < /etc/puavo/hostname
read puavo_samba_ad_domain_name < /var/lib/samba-ad-dc/.puavo_samba_ad_domain
read puavo_samba_domain         < /etc/puavo/sambadomainname

ad_realm=$(printf %s "$puavo_samba_ad_domain_name" | tr a-z A-Z)
netbios_name=$(printf %s "$puavo_hostname" | tr a-z A-Z)

cat <<EOF > /etc/samba/samba-ad-dc.conf
# Global parameters
[global]
        binddns dir = /var/lib/samba-ad-dc/bind-dns
        bind interfaces only = Yes
        cache directory = /var/lib/samba-ad-dc/cache
        dns forwarder = 127.0.0.1
        interfaces = win0
        lock directory = /var/lib/samba-ad-dc
        netbios name = ${netbios_name}
        pid directory = /run/samba-ad-dc
        private dir = /var/lib/samba-ad-dc/private
        realm = ${ad_realm}
        server role = active directory domain controller
        state directory = /var/lib/samba-ad-dc/state
        workgroup = ${puavo_samba_domain}
        idmap_ldb:use rfc2307 = yes

[sysvol]
        path = /var/lib/samba-ad-dc/state/sysvol
        read only = No

[netlogon]
        path = /var/lib/samba-ad-dc/state/sysvol/${puavo_samba_ad_domain_name}/scripts
        read only = No
EOF

cat <<'EOF' > /etc/default/samba
SAMBAOPTIONS="-s /etc/samba/samba-ad-dc.conf"
EOF
