#!/usr/bin/ruby

require 'dbus'
require 'syslog'

EXAMUSER_UID = 990
EXAMUSER_USERNAME = 'puavo-examuser'

class PuavoExammode < DBus::Object
  dbus_interface 'org.puavo.Exam.exammode' do
    dbus_method :Enable, '' do
      if !system('loginctl', 'lock-sessions') then
        raise 'error in locking desktop sessions'
      end
      if ! system('/etc/puavo-conf/scripts/setup_nodm', 'puavo-exammode') then
        raise 'could not configure nodm for exam mode'
      end
      if ! system('service nodm start') then
        raise 'error in starting up nodm'
      end
    end
  end
end

Syslog.open(File.basename($0), Syslog::LOG_CONS)

begin
  bus = DBus::SystemBus.instance
  service = bus.request_service('org.puavo.Exam')
  service.export( PuavoExammode.new('/exammode') )

  mainloop = DBus::Main.new
  mainloop << bus
  mainloop.run
rescue StandardError => e
  Syslog.log(Syslog::LOG_ERR,
             'Error when running puavo-exammode-manager dbus service: %s',
             e.message)
end

Syslog.close()
