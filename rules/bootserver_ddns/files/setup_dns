#!/bin/sh

set -eu

get_etc_puavo() {
  etc_puavo_data=$(cat "$1" 2>/dev/null) || true
  if [ -z "$etc_puavo_data" ]; then
    echo "Could not read data from $1" >&2
    return 1
  fi

  echo "$etc_puavo_data"
}

lookup_ifdata() {
  if_data_arg=$1
  if_fieldname=$2
  if_name=$3

  if_data=$(ifdata "$if_data_arg" "$if_name" 2>/dev/null) || true
  if [ -z "$if_data" ]; then
    if_data=$(
      awk -v if_fieldname="$if_fieldname" -v if_name="$if_name" '
        $1 == "iface" && $2 == if_name { found_interface_section = 1 }
        found_interface_section && $1 == if_fieldname { print $2; exit 0 }
      ' /etc/network/interfaces /etc/network/interfaces.d/* 2>/dev/null) \
        || true
  fi

  if [ -z "$if_data" ]; then
    return 1
  fi

  printf "%s\n" "$if_data"
}

lookup_ip()      { lookup_ifdata -pa address "$1"; }
lookup_netmask() { lookup_ifdata -pn netmask "$1"; }

# XXX get rid of hosttype handling
if [ "$(puavo-conf puavo.hosttype)" != 'bootserver' ]; then
  exit 0
fi

# XXX this should not be hardcoded to 10.XXX addresses!
arpazone='10.in-addr.arpa'

puavo_domain=$(           get_etc_puavo /etc/puavo/domain           )
puavo_hostname=$(         get_etc_puavo /etc/puavo/hostname         )
puavo_kerberos_realm=$(   get_etc_puavo /etc/puavo/kerberos/realm   )
puavo_kerberos_toprealm=$(get_etc_puavo /etc/puavo/kerberos/toprealm)
puavo_ldap_base=$(        get_etc_puavo /etc/puavo/ldap/base        )
puavo_ldap_master=$(      get_etc_puavo /etc/puavo/ldap/master      )
puavo_topdomain=$(        get_etc_puavo /etc/puavo/topdomain        )

# XXX should 'ltsp0' really be hardcoded here?
ltsp0_ip=$(lookup_ip ltsp0 2>/dev/null) || true
if [ -z "$ltsp0_ip" ]; then
  echo 'Could not determine ltsp0 interface address' >&2
  exit 1
fi

if [ ! -e /var/lib/bind/puavo_domain ]; then
  install -o bind -g bind -m 644 /dev/null /var/lib/bind/puavo_domain.tmp
  cat <<EOF > /var/lib/bind/puavo_domain.tmp
\$ORIGIN .
\$TTL 0          ; no TTL
${puavo_domain}         IN SOA  ns1.${puavo_domain}. 20101209. (
                                2010088447 ; serial
                                28800      ; refresh (8 hours)
                                3600       ; retry (1 hour)
                                604800     ; expire (1 week)
                                38400      ; minimum (10 hours 40 minutes)
                                )
                        NS      ns1.${puavo_domain}.
\$ORIGIN ${puavo_domain}.
ns1                     A       ${ltsp0_ip}
EOF
  mv /var/lib/bind/puavo_domain.tmp /var/lib/bind/puavo_domain
fi

if [ ! -e /var/lib/bind/puavo_domain_reverse ]; then
  install -o bind -g bind -m 644 /dev/null \
         /var/lib/bind/puavo_domain_reverse.tmp
  cat <<EOF > /var/lib/bind/puavo_domain_reverse.tmp
\$ORIGIN .
\$TTL 0          ; no TTL
${arpazone}             IN SOA  ${puavo_domain}. root.${puavo_domain}. (
                                2010088664 ; serial
                                604800     ; refresh (1 week)
                                86400      ; retry (1 day)
                                2419200    ; expire (4 weeks)
                                604800     ; minimum (1 week)
                                )
                        NS      ${puavo_domain}.
\$ORIGIN .
EOF
  mv /var/lib/bind/puavo_domain_reverse.tmp /var/lib/bind/puavo_domain_reverse
fi

# Create nsupdate.key for ddns-updates.  We do create a new one for every
# boot, because this is only used internally for this server.  In case this
# ever changes later, the key should be put under /state and the old one
# should not be overwritten.
mkdir -m 750 -p /etc/dhcp/ddns-keys
install -o root -g root -m 640 /dev/null /etc/dhcp/ddns-keys/nsupdate.key.tmp
ddns-confgen -a hmac-md5 -q > /etc/dhcp/ddns-keys/nsupdate.key.tmp
mv /etc/dhcp/ddns-keys/nsupdate.key.tmp /etc/dhcp/ddns-keys/nsupdate.key

install -o root -g bind -m 640 /etc/dhcp/ddns-keys/nsupdate.key \
                               /etc/bind/nsupdate.key

install -o root -g bind -m 644 /dev/null /etc/bind/named.conf.local.tmp
cat <<EOF > /etc/bind/named.conf.local.tmp
//
// Do any local configuration here
//

// Consider adding the 1918 zones here, if they are not used in your
// organization
//include "/etc/bind/zones.rfc1918";

include "/etc/bind/nsupdate.key";

zone "${puavo_domain}" {
        type master;
        file "/var/lib/bind/puavo_domain";
        update-policy {
                grant ddns-key zonesub ANY;
        };
};

zone "${arpazone}" {
        type master;
        file "/var/lib/bind/puavo_domain_reverse";
        update-policy {
                grant ddns-key zonesub ANY;
        };
};
EOF
mv /etc/bind/named.conf.local.tmp \
   /etc/bind/named.conf.local

cat <<EOF > /etc/dnsmasq.conf.tmp
domain=${puavo_domain}
domain-needed
cache-size=10000
dns-forward-max=1000

# Forward requests to upstream. Requests to puavo domain should be
# sent to bind that handles DDNS requests
server=/ltsp.${puavo_domain}/127.0.0.1#553
server=/wlan.${puavo_domain}/127.0.0.1#553
server=/249.10.in-addr.arpa/127.0.0.1#553

# Printer entries
server=/_ipp._tcp.${puavo_domain}/127.0.0.1#553

address=/${puavo_hostname}.${puavo_domain}/${ltsp0_ip}
address=/cups.${puavo_domain}/${ltsp0_ip}
address=/cups.ltsp.${puavo_domain}/${ltsp0_ip}
address=/cups.wlan.${puavo_domain}/${ltsp0_ip}
address=/kerberos.${puavo_domain}/${ltsp0_ip}
address=/ntp.${puavo_domain}/${ltsp0_ip}
address=/homedir.${puavo_domain}/${ltsp0_ip}
address=/homedir.ltsp.${puavo_domain}/${ltsp0_ip}
address=/homedir.wlan.${puavo_domain}/${ltsp0_ip}
address=/printserver.${puavo_domain}/${ltsp0_ip}
address=/wlangw.${puavo_domain}/${ltsp0_ip}
address=/wlangw.ltsp.${puavo_domain}/${ltsp0_ip}
address=/eventlog.${puavo_domain}/${ltsp0_ip}
address=/eventlog.ltsp.${puavo_domain}/${ltsp0_ip}
address=/syslog.${puavo_domain}/${ltsp0_ip}
address=/syslog.ltsp.${puavo_domain}/${ltsp0_ip}
address=/syslog.wlan.${puavo_domain}/${ltsp0_ip}

txt-record=_kerberos,"${puavo_kerberos_realm}"
txt-record=_kerberos.${puavo_domain},"${puavo_kerberos_realm}"
txt-record=_kerberos,"${puavo_kerberos_toprealm}"
txt-record=_kerberos.${puavo_topdomain},"${puavo_kerberos_toprealm}"
txt-record=_ldap_base.${puavo_domain},"${puavo_ldap_base}"
txt-record=_puavo,"${puavo_domain}"
txt-record=_puavo.${puavo_domain},"${puavo_domain}"
txt-record=_puavo.ltsp.${puavo_domain},"${puavo_domain}"
txt-record=_puavo.wlan.${puavo_domain},"${puavo_domain}"

srv-host=_sambaserver._udp.${puavo_domain},"${puavo_hostname}.${puavo_domain}",137
srv-host=_sambaserver._udp.${puavo_domain},"${puavo_hostname}.${puavo_domain}",138
srv-host=_sambaserver._tcp.${puavo_domain},"${puavo_hostname}.${puavo_domain}",139
srv-host=_sambaserver._tcp.${puavo_domain},"${puavo_hostname}.${puavo_domain}",445

srv-host=_imageserver._tcp.${puavo_domain},"${puavo_hostname}.${puavo_domain}",872
srv-host=_kerberos-adm._tcp.${puavo_domain},"kerberos.${puavo_domain}",749
srv-host=_kerberos-master._tcp.${puavo_domain},"kerberos.${puavo_domain}",88
srv-host=_kerberos-master._udp.${puavo_domain},"kerberos.${puavo_domain}",88
srv-host=_kerberos._tcp.${puavo_kerberos_realm},"kerberos.${puavo_domain}",88
srv-host=_kerberos._udp.${puavo_kerberos_realm},"kerberos.${puavo_domain}",88
srv-host=_kerberos._tcp.${puavo_kerberos_toprealm},"kerberos.${puavo_topdomain}",88
srv-host=_kerberos._udp.${puavo_kerberos_toprealm},"kerberos.${puavo_topdomain}",88
srv-host=_kpasswd._udp.${puavo_domain},"kerberos.${puavo_domain}",464
srv-host=_ldap_master._tcp.${puavo_domain},${puavo_ldap_master},389
srv-host=_ldap._tcp.${puavo_domain},${puavo_hostname}.${puavo_domain},389
srv-host=_puavo._tcp.${puavo_domain},"${puavo_domain}",80
srv-host=_puavo._tcp.ltsp.${puavo_domain},"${puavo_domain}",80
srv-host=_puavo._tcp.wlan.${puavo_domain},"${puavo_domain}",80
srv-host=_puavo-api._tcp.${puavo_domain},"${puavo_hostname}.${puavo_domain}",443

# DNS entries needed for AirPrint printing
ptr-record=b._dns-sd._udp,${puavo_domain}
ptr-record=lb._dns-sd._udp,${puavo_domain}
ptr-record=b._dns-sd._udp.${puavo_domain},${puavo_domain}
ptr-record=lb._dns-sd._udp.${puavo_domain},${puavo_domain}
ptr-record=b._dns-sd._udp.ltsp.${puavo_domain},${puavo_domain}
ptr-record=lb._dns-sd._udp.ltsp.${puavo_domain},${puavo_domain}
ptr-record=b._dns-sd._udp.wlan.${puavo_domain},${puavo_domain}
ptr-record=lb._dns-sd._udp.wlan.${puavo_domain},${puavo_domain}
EOF
mv /etc/dnsmasq.conf.tmp /etc/dnsmasq.conf

# Setup /etc/hosts
{
  cat <<EOF
127.0.0.1       localhost

${ltsp0_ip}     ${puavo_hostname}.${puavo_domain} ${puavo_hostname} wlangw

# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost   ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
EOF
  if [ -s /state/etc/hosts ]; then
    echo
    echo '# from /state/etc/hosts:'
    cat /state/etc/hosts
  fi
} >> /etc/hosts.tmp
mv /etc/hosts.tmp /etc/hosts
