#!/bin/sh

set -eu

target_dir='/etc/shorewall.rofs'

iface_to_network_cidr() {
  iface=$1

  network_cidr=$(
    awk -v iface="$iface" '
      $1 == "iface" { current_iface = $2; address = ""; netmask = "" }
      current_iface == iface && $1 == "address" { address = $2 }
      current_iface == iface && $1 == "netmask" { netmask = $2 }
      address && netmask { print address, netmask; exit(0) }
    ' /etc/network/interfaces /etc/network/interfaces.d/* \
      | awk 'BEGIN {
               netMaskToCIDR["0.0.0.0"]         = 0
               netMaskToCIDR["128.0.0.0"]       = 1
               netMaskToCIDR["192.0.0.0"]       = 2
               netMaskToCIDR["224.0.0.0"]       = 3
               netMaskToCIDR["240.0.0.0"]       = 4
               netMaskToCIDR["248.0.0.0"]       = 5
               netMaskToCIDR["252.0.0.0"]       = 6
               netMaskToCIDR["254.0.0.0"]       = 7
               netMaskToCIDR["255.0.0.0"]       = 8
               netMaskToCIDR["255.128.0.0"]     = 9
               netMaskToCIDR["255.192.0.0"]     = 10
               netMaskToCIDR["255.224.0.0"]     = 11
               netMaskToCIDR["255.240.0.0"]     = 12
               netMaskToCIDR["255.248.0.0"]     = 13
               netMaskToCIDR["255.252.0.0"]     = 14
               netMaskToCIDR["255.254.0.0"]     = 15
               netMaskToCIDR["255.255.0.0"]     = 16
               netMaskToCIDR["255.255.128.0"]   = 17
               netMaskToCIDR["255.255.192.0"]   = 18
               netMaskToCIDR["255.255.224.0"]   = 19
               netMaskToCIDR["255.255.240.0"]   = 20
               netMaskToCIDR["255.255.248.0"]   = 21
               netMaskToCIDR["255.255.252.0"]   = 22
               netMaskToCIDR["255.255.254.0"]   = 23
               netMaskToCIDR["255.255.255.0"]   = 24
               netMaskToCIDR["255.255.255.128"] = 25
               netMaskToCIDR["255.255.255.192"] = 26
               netMaskToCIDR["255.255.255.224"] = 27
               netMaskToCIDR["255.255.255.240"] = 28
               netMaskToCIDR["255.255.255.248"] = 29
               netMaskToCIDR["255.255.255.252"] = 30
               netMaskToCIDR["255.255.255.254"] = 31
               netMaskToCIDR["255.255.255.255"] = 32
             }

             {
               ip_address = $1
               netmask    = $2
               split(ip_address, a, /\./)
               split(netmask,    b, /\./)
               network = and(a[1], b[1]) "." and(a[2], b[2]) "."  and(a[3], b[3]) "." and(a[4], b[4])

               print network "/" netMaskToCIDR[netmask]
               exit(0)
             }')
  if [ -z "$network_cidr" ]; then
    echo "Could not determine network/cidr for interface $iface" >&2
    return 1
  fi

  echo "$network_cidr"
}

iface_no_num() { echo "$1" | sed -E 's/[0-9]+$//'; }

get_dhcp_interfaces() {
  all_interfaces=$(awk '$1 == "iface" { print $2 }' /etc/network/interfaces \
                                                    /etc/network/interfaces.d/*)

  puavo_dhcpd_interfaces=$(puavo-conf puavo.networking.ddns.dhcpd_interfaces)
  for if_filter in $(echo "$puavo_dhcpd_interfaces" | tr , ' '); do
    for interf in $all_interfaces; do
      case "$interf" in
        $if_filter)
          echo "$interf"
          ;;
      esac
    done
  done
}

dhcpd_interfaces=$(get_dhcp_interfaces)

# -- interfaces
cat <<EOF > "${target_dir}/interfaces.tmp"
#ZONE	INTERFACE	BROADCAST	OPTIONS
inet	inet0		detect		dhcp,tcpflags,nosmurfs,bridge
$(for iface in $dhcpd_interfaces; do
    echo "$(iface_no_num "$iface")	${iface}	        detect		dhcp,tcpflags,nosmurfs,bridge"
  done)
ovpn	vpn0
EOF
mv "${target_dir}/interfaces.tmp" "${target_dir}/interfaces"

# -- masq
cat <<EOF > "${target_dir}/masq.tmp"
#INTERFACE:DEST         SOURCE          ADDRESS         PROTO   PORT(S) IPSEC   MARK    USER/
#                                                                                       GROUP
$(for iface in $dhcpd_interfaces; do
    echo "inet0		$(iface_to_network_cidr "$iface")"
    echo "vpn0		$(iface_to_network_cidr "$iface")"
  done)
EOF
mv "${target_dir}/masq.tmp" "${target_dir}/masq"

# -- policy
cat <<EOF > "${target_dir}/policy.tmp"
#SOURCE         DEST            POLICY          LOG LEVEL       LIMIT:BURST
inet            fw              REJECT
fw              all		ACCEPT
ltsp            inet            ACCEPT
ltsp            ovpn            ACCEPT
ltsp            fw              ACCEPT
ovpn            fw              ACCEPT
wlan            inet            ACCEPT
wlan            fw              ACCEPT
wlan            ovpn		REJECT
all             all             REJECT
EOF
mv "${target_dir}/policy.tmp" "${target_dir}/policy"

# -- rules
cat <<EOF > "${target_dir}/rules.tmp"
#ACTION         SOURCE          	DEST            	PROTO   DEST    SOURCE          ORIGINAL        RATE            USER/   MARK    CONNLIMIT       TIME         HEADERS         SWITCH
#                                                       	PORT    PORT(S) 		DEST            LIMIT           GROUP
ACCEPT		any			any			icmp    8

# Maybe enable for some cases:
#ACCEPT		inet			fw			tcp	22
EOF
mv "${target_dir}/rules.tmp" "${target_dir}/rules"

# -- zones
cat <<EOF > "${target_dir}/zones.tmp"
#ZONE   TYPE    OPTIONS                 IN                      OUT
#                                       OPTIONS                 OPTIONS
fw      firewall
inet    ipv4		# Internet
ltsp    ipv4		# LTSP network(s)
ovpn    ipv4		# OpenVPN for server administration
wlan    ipv4		# WLAN network(s)
EOF
mv "${target_dir}/zones.tmp" "${target_dir}/zones"
