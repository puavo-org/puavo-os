#!/usr/bin/rake -mf

require 'json'

Image_dir      = ENV['image_dir']
Images_urlbase = ENV['images_urlbase']
Mirror_dir     = ENV['mirror_dir']

raise '"image_dir" environment variable not defined' \
  if Image_dir.nil? || Image_dir.empty?

raise '"images_urlbase" environment variable not defined' \
  if Images_urlbase.nil? || Images_urlbase.empty?

raise '"mirror_dir" environment variable not defined' \
  if Mirror_dir.nil? || Mirror_dir.empty?

Checksums_dir  = "#{ Mirror_dir }/.checksums"
Metadata_dir   = "#{ Mirror_dir }/meta"
Rdiffs_dir     = "#{ Mirror_dir }/rdiffs"
Signatures_dir = "#{ Mirror_dir }/.signatures"

Cksums_file = "#{ Mirror_dir }/CKSUMS"

directory Checksums_dir
directory Metadata_dir
directory Rdiffs_dir
directory Signatures_dir

Image_series_json_path = 'images.json'

$all_cksum_files = []

def calc_checksum(cmd, source_file_path, output_path)
  basename = File.basename(source_file_path)
  dirname  = File.dirname(source_file_path)

  tmpfile = "#{ output_path }.tmp"

  pid = spawn(cmd, basename, :chdir => dirname, :out => tmpfile)
  Process.wait(pid)
  raise "Error running command #{ cmd } #{ source_file_path }" \
    unless $?.exitstatus == 0

  mv tmpfile, output_path
end

def find_rdiff_file(source_image, target_image)
  image_regexp = /^(.*?)-(\d{4}-\d{2}-\d{2}-\d{6})-(.*?).img$/

  source_match = source_image.match(image_regexp)
  raise "Bad image format '#{ source_image }'" unless source_match

  target_match = target_image.match(image_regexp)
  raise "Bad image format '#{ target_image }'" unless target_match

  return sprintf('%s-%s--%s-%s.rdiff',
		 source_match[1],
		 source_match[2],
		 target_match[2],
		 source_match[3])
end

def get_cksum_path(filename)
  "#{ Checksums_dir }/#{ filename }.cksum"
end

def get_sha256sum_path(filename)
  "#{ Checksums_dir }/#{ filename }.sha256sum"
end

def get_image_version(image_name)
  return get_version(image_name, /-(\d+)-(\d+)-(\d+)-(\d+).*\.img\z/)
end

def get_rdiff_version(rdiff_file)
  return get_version(rdiff_file, /-(\d+)-(\d+)-(\d+)-(\d+)--.*\.rdiff\z/)
end

def get_version(name, version_re)
  versionmatch = name.match(version_re)
  raise "Could not determine version for #{ name }" unless versionmatch
  return versionmatch[1..4].join
end

def make_metadata_file(series_metadata, series_metadata_file)
  series_metadata['images'].each do |image_metadata|
    imagename = image_metadata['filename']
    image_metadata['cksum'] = read_cksum(imagename)
    image_metadata['sha256sum'] = read_sha256sum(imagename)

    image_metadata['diffs'].each do |rdiff_metadata|
      rdiff_file = rdiff_metadata['filename']
      rdiff_metadata['size'] = File.size("#{ Rdiffs_dir }/#{ rdiff_file }")
      rdiff_metadata['cksum'] = read_cksum(rdiff_file)
      rdiff_metadata['sha256sum'] = read_sha256sum(rdiff_file)
    end
  end

  tmpfile = "#{ series_metadata_file }.tmp"
  File.open(tmpfile, 'w') do |f|
    f.write(series_metadata.to_json)
  end
  mv tmpfile, series_metadata_file
end

def parse_image_series(json_path)
  image_series = JSON.parse( File.read(json_path) )

  raise 'expecting hash' unless image_series.kind_of?(Hash)
  image_series.each do |key, value|
    raise 'expecting string as key' unless key.kind_of?(String)
    raise 'expecting list as value' unless value.kind_of?(Array)
    value.each do |item|
      raise 'expecting string as list value' unless item.kind_of?(String)
    end
  end

  return image_series
end

def read_checksum_from_file(path)
  data = IO.read(path)
  checksum = (data.split)[0]
  raise "Could not read checksum from file '#{ path }'" \
    if checksum.nil? || checksum.empty?
  return checksum
end

def read_cksum(filename)
  read_checksum_from_file( get_cksum_path(filename) )
end

def read_sha256sum(filename)
  read_checksum_from_file( get_sha256sum_path(filename) )
end

def setup_rdiff_tasks(source_image_file, target_image_file, metadata_file)
  source_image_file_fp = "#{ Image_dir }/#{ source_image_file }"

  rdiff_file = find_rdiff_file(source_image_file, target_image_file)
  rdiff_file_fp = "#{ Rdiffs_dir }/#{ rdiff_file }"

  source_image_signature_file = "#{ source_image_file }.rdiff_signature"
  source_image_signature_file_fp =
      "#{ Signatures_dir }/#{ source_image_signature_file }"

  file source_image_signature_file_fp => Signatures_dir
  file source_image_signature_file_fp => source_image_file_fp do |t|
    tmpfile = "#{ source_image_signature_file_fp }.tmp"
    sh 'rdiff', 'signature', source_image_file_fp, tmpfile
    mv tmpfile, t.name
  end

  target_image_file_fp = "#{ Image_dir }/#{ target_image_file }"

  task rdiff_file => rdiff_file_fp
  file rdiff_file_fp => [ Rdiffs_dir,
			  source_image_signature_file_fp,
			  target_image_file_fp ]
  file rdiff_file_fp do |t|
    tmpfile = "#{ rdiff_file_fp }.tmp"
    sh 'rdiff', 'delta', source_image_signature_file_fp, target_image_file_fp,
      tmpfile
    mv tmpfile, t.name
  end

  rdiff_cksum_file = get_cksum_path(rdiff_file)
  file rdiff_cksum_file => rdiff_file_fp do |t|
    calc_checksum('cksum', rdiff_file_fp, t.name)
  end
  $all_cksum_files << rdiff_cksum_file

  rdiff_sha256sum_file = get_sha256sum_path(rdiff_file)
  file rdiff_sha256sum_file => rdiff_file_fp do |t|
    calc_checksum('sha256sum', rdiff_file_fp, t.name)
  end

  file metadata_file => [ rdiff_file_fp,
                          rdiff_cksum_file,
                          rdiff_sha256sum_file ]

  return {
    'filename' => rdiff_file,
    'urls'     => "#{ Images_urlbase }/rdiffs/#{ rdiff_file }",
    'version'  => get_rdiff_version(rdiff_file),
   }
end

#
# main
#

begin
  image_series = parse_image_series(Image_series_json_path)
rescue StandardError => err
  warn "Error in parsing #{ Image_series_json_path }: #{ err.message }"
  exit 1
end

#
# tasks
#

task :default => [ Cksums_file, :all_series ]

file Cksums_file

task :all_series

image_series.each do |series_name, image_list|
  task series_name
  task :all_series => series_name

  series_metadata = { 'images' => [] }

  series_metadata_file = "#{ Metadata_dir }/#{ series_name }.json"
  task series_name => series_metadata_file

  file series_metadata_file => Metadata_dir

  target_image_rdiff_target = nil

  image_list.each_index do |i|
    target_image_file = image_list[i]
    target_image_rdiff_target = "#{ target_image_file }-rdiffs"

    target_image_file_copy = "#{ Mirror_dir }/#{ target_image_file }"
    target_image_file_fp   = "#{ Image_dir }/#{ target_image_file }"

    target_image_cksum_file = get_cksum_path(target_image_file)
    $all_cksum_files << target_image_cksum_file

    file target_image_cksum_file => [ Checksums_dir, target_image_file_copy ]
    file target_image_cksum_file do |t|
      calc_checksum('cksum', target_image_file_copy, t.name)
    end

    target_image_sha256sum_file = get_sha256sum_path(target_image_file)

    file target_image_sha256sum_file =>
      [ Checksums_dir, target_image_file_copy ]
    file target_image_sha256sum_file do |t|
      calc_checksum('sha256sum', target_image_file_copy, t.name)
    end

    task target_image_rdiff_target
    task series_name => target_image_rdiff_target
    task series_name => target_image_file_copy

    file target_image_file_copy => target_image_file_fp do |t|
      # This presumes that source and target are in the same filesystem.
      # If this is not the case, fix your configuration.
      ln target_image_file_fp, t.name
    end

    image_metadata = {
      'diffs'    => [],
      'filename' => target_image_file,
      'id'       => File.basename(target_image_file, '.img'),
      'size'     => File.size(target_image_file_fp),
      'urls'     => "#{ Images_urlbase }/#{ target_image_file }",
      'version'  => get_image_version(target_image_file),
     }

    file series_metadata_file => [ target_image_cksum_file,
                                   target_image_file_copy,
                                   target_image_sha256sum_file ]

    image_list.each_index do |j|
      # make rdiffs only to one direction (from earlier to later)
      next if i <= j

      source_image_file = image_list[j]

      rdiff_metadata = setup_rdiff_tasks(source_image_file, target_image_file,
        series_metadata_file)

      task target_image_rdiff_target => rdiff_metadata['filename']

      image_metadata['diffs'] << rdiff_metadata
    end

    series_metadata['images'] << image_metadata
  end

  file series_metadata_file do |t|
    make_metadata_file(series_metadata, series_metadata_file)
  end

  if target_image_rdiff_target then
    task "latest-#{ series_name }" => target_image_rdiff_target
  end
end

file Cksums_file => $all_cksum_files do |t|
  tmpfile = "#{ Cksums_file }.tmp"
  File.open(tmpfile, 'w') do |f|
    $all_cksum_files.each do |cksum_file|
      f.write( IO.read(cksum_file) )
    end
  end
  mv tmpfile, Cksums_file
end
